#!/usr/bin/bash

set -e

RESULTSD="$1"
OPWD="$PWD"

cd $RESULTSD

find *.d/*.d/ -type d | sort -h | while read TESTDIR; do
  RELTESTDIR=$(realpath -s --relative-to="$OPWD" "$TESTDIR")

  # Preints <PASS|FAIL> <PATH>
  echo $(readlink $TESTDIR/result) $TESTDIR

  HAD_DETAILS=false
  for C in FAIL INFO WARN; do
    [[ -f $TESTDIR/$C ]] && { sed "s/^/     /" $TESTDIR/$C ; HAD_DETAILS=true ; } ;
  done

  if $HAD_DETAILS;
  then
    echo "     See the files in '$RELTESTDIR' for more details. Specifically log.txt, also encoded below"
    #echo "     $ tar tf results.tar $TESTDIR/log.txt --to-stdout"
  fi
done | colorfy
